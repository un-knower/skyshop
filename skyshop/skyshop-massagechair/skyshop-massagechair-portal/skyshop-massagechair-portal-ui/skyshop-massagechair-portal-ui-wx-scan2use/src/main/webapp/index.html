<!DOCTYPE html>
<html>
	<head>
		<title>选择费率 - 三网通-按摩椅</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width"/>
		<meta name="apple-mobile-web-app-capable" content="yes"/>
		<meta http-equiv="keywords" content="三网通-按摩椅"/>
		<meta http-equiv="description" content="三网通-按摩椅"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="renderer"  content="webkit|ie-comp|ie-stand">
		
		<link rel="stylesheet" type="text/css" href="plugins/jqweui/lib/weui.css"/>
		<link rel="stylesheet" type="text/css" href="plugins/jqweui/css/jquery-weui.css"/>
		
		<link rel="stylesheet" type="text/css" href="css/style.css"/>
		
		<script type="text/javascript" src="plugins/jqweui/lib/jquery-2.1.4.js"></script>
		<script type="text/javascript" src="plugins/jqweui/js/jquery-weui.js"></script>
		<script type="text/javascript" src="js/ctx.js"></script>
		<script type="text/javascript" src="js/ui.js"></script>
		
		<script type="text/javascript">
			$(function(){
			    var imei = window.location.search;
			    if(!imei) {
			        window.location.href = 'fault.html?imei_err';
			        return;
			    }
			    
		        doAjax('/scan2use/' + imei, function(r){
		            if(data.code != '200') {
		                var name = r.data.name;
		                var prices = r.data.prices;
		                if(prices && prices.length > 0) {
		                    for (var i = 0; i < prices.length; i++) {
                                var p = prices[i];
                                $('.content').append('<div class="btn"><img chairname="' + name + '" chairid="' + r.data.id + '" mins="' + p.minutes + '" money="' + p.amount + '" title="' + p.name + '" src="' + p.img + '" /></div>');
                            }
		                    
		                    addListeners();
		                }
		            } else {
		                $.alert("这台按摩椅不能使用，试试其他的吧~");
	                }
		        }, 'get');
			    
		        
		        function addListeners() {
				    $('.btn > img').click(function(){
				        // 请求后台，检测设备
				        var money = $(this).attr('money');
				        var mins = $(this).attr('mins');
				        var price = $(this).attr('title');
				        var chairid = $(this).attr('chairid');
				        var chairname = $(this).attr('chairname');
				        
				        var order = {};
				        order.minutes = mins;
				        order.money = money;
				        order.chair.id = chairid;
				        order.code = new Date().getTime();
				        
				        // 订单
				        doAjax('/order', order, function(data){
				            if(data.code == '200') {
				                pay(chairname + '_' + price, money, mins, ordercode);
				            } else {
				                $.alert("订单生成失败，请重新扫码二维码");
				            }
				        }, 'POST');
				        
				    });
		        }
		        
		        function pay(chair_price_name, money, mins, ordercode) {
		         	// 发起支付
			        var out_trade_no = ordercode;
			        var body = chair_price_name;
			        var total_fee = parseFloat(money) * 100;
			        var notify_url = api_server_url + '/order/paynotify/';
			        var backUrl = ui_server_url + '/working.html?mins=' + mins + '&chair_price_name=' + chair_price_name;
			        
			        var url = 'http://kehu.tba-taobao.com/WXPayAPI_QQT/PayJsAPIOpenid.aspx?out_trade_no=' + out_trade_no + '&body=' 
			            + body + '&total_fee=' + total_fee + '&backUrl=' + backUrl + '&notify_url=' + notify_url;
			        
			        window.location.href = url;
		        }
			});
		</script>
	</head>
	<body>
		<div class="header" >
		</div>
		<div class="content">
			<div>请打开微信，使用“扫一扫”扫描按摩椅的二维码</div>
<!-- 			<div class="btn"><img mins="5" title="5分钟套餐" src="images/f1.png" /></div> -->
<!-- 			<div class="btn"><img mins="10" title="10分钟套餐" src="images/f2.png" /></div> -->
<!-- 			<div class="btn"><img mins="15" title="15分钟套餐" src="images/f3.png" /></div> -->
<!-- 			<div class="btn"><img mins="20" title="20分钟套餐" src="images/f4.png" /></div> -->
		</div>
	</body>
</html>